#!/usr/bin/env python3

"""
Example analyzing script for saved exports (by main.py, as JSON).
This file belongs to https://github.com/bitkeks/python-netflow-v9-softflowd.

Copyright 2017-2019 Dominik Pataky <dev@bitkeks.eu>
Licensed under MIT License. See LICENSE.
"""

from datetime import datetime
import ipaddress
import json
import os.path
import sys
import socket
from collections import namedtuple

from kafka import KafkaConsumer

protocal_dict = {
    0  	:"    0",	
    1  	:"ICMP ",	
    2	:"IGMP ",	
    3	:"GGP  ",	
    4	:"IPIP ",	
    5	:"ST   ",	
    6	:"TCP  ",	
    7	:"CBT  ",	
    8	:"EGP  ",	
    9	:"IGP  ",	
    10	:"BBN  ",	
    11	:"NVPII",	
    12	:"PUP  ",	
    13	:"ARGUS",	
    14	:"ENCOM",	
    15	:"XNET ",	
    16	:"CHAOS",	
    17	:"UDP  ",	
    18	:"MUX  ",	
    19	:"DCN  ",	
    20	:"HMP  ",	
    21	:"PRM  ",	
    22	:"XNS  ",	
    23	:"Trnk1",	
    24	:"Trnk2",	
    25	:"Leaf1",	
    26	:"Leaf2",	
    27	:"RDP  ",	
    28	:"IRTP ",	
    29	:"ISO-4",	
    30	:"NETBK",	
    31	:"MFESP",	
    32	:"MEINP",	
    33	:"DCCP ",	
    34	:"3PC  ",	
    35	:"IDPR ",	
    36	:"XTP  ",	
    37	:"DDP  ",	
    38	:"IDPR ",	
    39	:"TP++ ",	
    40	:"IL   ",	
    41	:"IPv6 ",	
    42	:"SDRP ",	
    43	:"Rte6 ",	
    44	:"Frag6",	
    45	:"IDRP ",	
    46	:"RSVP ",	
    47	:"GRE  ",	
    48	:"MHRP ",	
    49	:"BNA  ",	
    50	:"ESP  ",    
    51	:"AH   ",    
    52	:"INLSP",    
    53	:"SWIPE",    
    54	:"NARP ",    
    55	:"MOBIL",    
    56	:"TLSP ",    
    57	:"SKIP ",    
    58	:"ICMP6",	
    59	:"NOHE6",    
    60	:"OPTS6",    
    61	:"HOST ",    
    62	:"CFTP ",    
    63	:"NET  ",    
    64	:"SATNT",    
    65	:"KLAN ",    
    66	:"RVD  ",    
    67	:"IPPC ",    
    68	:"FS   ",    
    69	:"SATM ",    
    70	:"VISA ",    
    71	:"IPCV ",    
    72	:"CPNX ",    
    73	:"CPHB ",    
    74	:"WSN  ",    
    75	:"PVP  ",    
    76	:"BSATM",    
    77	:"SUNND",    
    78	:"WBMON",    
    79	:"WBEXP",    
    80	:"ISOIP",    
    81	:"VMTP ",    
    82	:"SVMTP",    
    83	:"VINES",    
    84	:"TTP  ",    
    85	:"NSIGP",    
    86	:"DGP  ",    
    87	:"TCF  ",    
    88	:"EIGRP",    
    89	:"OSPF ",    
    90	:"S-RPC",    
    91	:"LARP ",    
    92	:"MTP  ",    
    93	:"AX.25",    
    94	:"IPIP ",	
    95	:"MICP ",    
    96	:"SCCSP",    
    97	:"ETHIP",    
    98	:"ENCAP",    
    99	:"99   ",    
    100	:"GMTP ",    
    101	:"IFMP ",    
    102	:"PNNI ",    
    103	:"PIM  ",	
    104	:"ARIS ",    
    105	:"SCPS ",    
    106	:"QNX  ",    
    107	:"A/N  ",    
    108	:"IPcmp",    
    109	:"SNP  ",    
    110	:"CpqPP",    
    111	:"IPXIP",    
    112	:"VRRP ",    
    113	:"PGM  ",    
    114	:"0hop ",    
    115	:"L2TP ",    
    116	:"DDX  ",    
    117	:"IATP ",    
    118	:"STP  ",    
    119	:"SRP  ",    
    120	:"UTI  ",    
    121	:"SMP  ",    
    122	:"SM   ",    
    123	:"PTP  ",    
    124	:"ISIS4",    
    125	:"FIRE ",    
    126	:"CRTP ",    
    127	:"CRUDP",    
    128	:"128  ",    
    129	:"IPLT ",    
    130	:"SPS  ",    
    131	:"PIPE ",    
    132	:"SCTP ",    
    133	:"FC   ",    
    134	:"134  ",    
    135	:"MHEAD",    
    136	:"UDP-L",    
    137	:"MPLS "       
}

tcp_wellknown_port = {
    1 : "TCP Port Service Multiplexer" ,
    2 : "Death" ,
    5 : "Remote Job Entry,yoyo" ,
    7 : "Echo" ,
    11 : "Skun" ,
    12 : "Bomber" ,
    16 : "Skun" ,
    17 : "Skun" ,
    18 : "Skun" ,
    19 : "Skun" ,
    20 : "FTP" ,
    21 : "FTP" ,
    22 : "SSH" ,
    23 : "Telnet" ,
    25 : "SMTP" ,
    27 : "Assasin" ,
    28 : "Amanda" ,
    29 : "MSG ICP" ,
    30 : "Agent 40421" ,
    31 : "Agent 31,Hackers Paradise,Masters Paradise,Agent 40421" ,
    37 : "Time,ADM worm" ,
    39 : "SubSARI" ,
    41 : "DeepThroat,Foreplay" ,
    42 : "Host Name Server" ,
    43 : "WHOIS" ,
    44 : "Arctic" ,
    48 : "DRAT" ,
    49 : "tacacs" ,
    50 : "DRAT" ,
    51 : "IMP Logical Address Maintenance" ,
    52 : "MuSka52,Skun" ,
    53 : "DNS" ,
    54 : "MuSka52" ,
    58 : "DMSetup" ,
    59 : "DMSetup" ,
    63 : "whois++" ,
    64 : "Communications Integrator" ,
    65 : "TACACS-Database Service" ,
    66 : "Oracle SQL*NET,AL-Bareki" ,
    67 : "Bootstrap Protocol Server" ,
    68 : "Bootstrap Protocol Client" ,
    69 : "W32.Evala.Worm,BackGate Kit,Nimda,Pasana,Storm,Storm worm,Theef, Worm.Cycle.a" ,
    70 : "Gopher" ,
    79 : "Finger" ,
    80 : "HTTP" ,
    81 : "Chubo,Worm.Bbeagle.q" ,
    82 : "Netsky-Z" ,
    88 : "Kerberos krb5 服务" ,
    99 : "Hidden Port" ,
    102 : "消息传输代理" ,
    108 : "SNA 网关访问服务器" ,
    109 : "Pop2" ,
    110 : "Pop3" ,
    113 : "Kazimas, Auther Idnet" ,
    115 : "简单文件传输协议" ,
    118 : "SQL Services, Infector 1.4.2" ,
    119 : "Newsgroup(Nntp)" ,
    121 : "JammerKiller, Bo jammerkillah" ,
    123 : "NTP" ,
    129 : "Password Generator Protocol" ,
    133 : "Infector 1.x" ,
    135 : "微软DCE RPC end-point mapper服务" ,
    137 : "微软Netbios Name 服务( 网上邻居传输文件使用)" ,
    138 : "微软Netbios Name 服务( 网上邻居传输文件使用)" ,
    139 : "微软Netbios Name 服务( 用于文件及打印机共享)" ,
    142 : "NetTaxi" ,
    143 : "IMAP" ,
    146 : "FC Infector,Infector" ,
    150 : "NetBIOS Session Service" ,
    156 : "SQL 服务器" ,
    161 : "Snmp" ,
    162 : "Snmp-Trap" ,
    170 : "A-Trojan" ,
    177 : "X Display 管理控制协议" ,
    179 : "BGP" ,
    190 : "GACP" ,
    194 : "Irc" ,
    197 : "DLS" ,
    256 : "Nirvana" ,
    315 : "The Invasor" ,
    371 : "ClearCase 版本管理软件" ,
    389 : "LDAP" ,
    396 : "Novell Netware over IP" ,
    420 : "Breach" ,
    421 : "TCP Wrappers" ,
    443 : "安全服务" ,
    444 : "SNPP" ,
    445 : "Microsoft-DS" ,
    455 : "Fatal Connections" ,
    456 : "Hackers paradise,FuseSpark" ,
    458 : "Apple QuickTime" ,
    513 : "Grlogin" ,
    514 : "RPC Backdoor" ,
    520 : "Rip" ,
    531 : "Rasmin,Net666" ,
    544 : "kerberos kshell" ,
    546 : "DHCP Client" ,
    547 : "DHCP Server" ,
    548 : "Macintosh 文件服务" ,
    555 : "Ini-Killer,Phase Zero,Stealth Spy" ,
    569 : "MSN" ,
    605 : "SecretService" ,
    606 : "Noknok8" ,
    660 : "DeepThroat" ,
    661 : "Noknok8" ,
    666 : "Attack FTP,Satanz Backdoor,Back Construction,Dark Connection Inside 1.2" ,
    667 : "Noknok7.2" ,
    668 : "Noknok6" ,
    669 : "DP trojan" ,
    692 : "GayOL" ,
    707 : "Welchia,nachi" ,
    777 : "AIM Spy" ,
    808 : "RemoteControl,WinHole" ,
    815 : "Everyone Darling" ,
    901 : "Backdoor.Devil" ,
    911 : "Dark Shadow" ,
    993 : "IMAP" ,
    999 : "DeepThroat" ,
    1000 : "Der Spaeher" ,
    1001 : "Silencer,WebEx,Der Spaeher" ,
    1003 : "BackDoor" ,
    1010 : "Doly" ,
    1011 : "Doly" ,
    1012 : "Doly" ,
    1015 : "Doly" ,
    1016 : "Doly" ,
    1020 : "Vampire" ,
    1023 : "Worm.Sasser.e" ,
    1024 : "NetSpy.698(YAI)" ,
    1059 : "nimreg" ,
    1028 : "应用层网关服务" ,
    1058 : "nim" ,
    1069 : "Backdoor.TheefServer.202" ,
    1070 : "Voice,Psyber Stream Server,Streaming Audio Trojan" ,
    1079 : "ASPROVATalk" ,
    1080 : "Wingate, Worm.BugBear.B ,Worm.Novarg.B" ,
    1109 : "Pop with Kerberos" ,
    1110 : "nfsd-keepalive" ,
    1111 : "Backdoor.AIMVision" ,
    1155 : "Network File Access" ,
    1270 : "Microsoft Operations Manager" ,
    1352 : "Lotus Notes" ,
    1433 : "Microsoft SQL Server" ,
    1434 : "Microsoft SQL Monitor" ,
    1503 : "NetMeeting T.120" ,
    1512 : "Microsoft Windows Internet Name Service" ,
    1570 : "Orbix Daemon" ,
    1720 : "NetMeeting H.233 call Setup" ,
    1731 : "NetMeeting 音频调用控制" ,
    1745 : "ISA Server proxy autoconfig,Remote Winsock" ,
    1801 : "Microsoft Message Queue" ,
    1906 : "Backdoor/Verify.b" ,
    1907 : "Backdoor/Verify.b" ,
    1990 : "stun-p1 cisco STUN Priority 1 port" ,
    1990 : "stun-p1 cisco STUN Priority 1 port" ,
    1991 : "stun-p2 cisco STUN Priority 2 port" ,
    1992 : "stun-p3 cisco STUN Priority 3 port,ipsendmsg IPsendmsg" ,
    1993 : "snmp-tcp-port cisco SNMP TCP port" ,
    1994 : "stun-port cisco serial tunnel port" ,
    1995 : "perf-port cisco perf port" ,
    1996 : "tr-rsrb-port cisco Remote SRB port" ,
    1997 : "gdp-port cisco Gateway Discovery Protocol" ,
    1998 : "x25-svc-port cisco X.25 service (XOT)" ,
    2002 : "W32.Beagle. AX @mm" ,
    2011 : "cypress" ,
    2015 : "raid-cs" ,
    2049 : "NFS" ,
    2234 : "DirectPlay" ,
    2556 : "Worm.Bbeagle.q" ,
    2745 : "Worm.BBeagle .k" ,
    2967 : "SSC Agent" ,
    3074 : "Microsoft Xbox game port" ,
    3127 : "Worm.Novarg" ,
    3128 : "RingZero,Worm.Novarg.B" ,
    3132 : "Microsoft Business Rule Engine Update Service" ,
    3198 : "Worm.Novarg" ,
    3268 : "Microsoft Global Catalog" ,
    3269 : "Microsoft Global Catalog with LDAP/SSL" ,
    3332 : "Worm.Cycle.a" ,
    3333 : "Prosiak" ,
    3535 : "Microsoft Class Server" ,
    3389 : "超级终端" ,
    3847 : "Microsoft Firewall Control" ,
    3996 : "Portal of Doom,RemoteAnything" ,
    4000 : "腾讯QQ客户端" ,
    4060 : "Portal of Doom,RemoteAnything" ,
    4092 : "WinCrash" ,
    4242 : "VHM" ,
    4267 : "SubSeven2.1&2.2" ,
    4321 : "BoBo" ,
    4350 : "Net Device" ,
    4444 : "Prosiak,Swift remote" ,
    4500 : "Microsoft IPsec NAT-T, W32.HLLW.Tufas" ,
    4567 : "File Nail" ,
    4661 : "Backdoor/Surila.f" ,
    4590 : "ICQTrojan" ,
    4899 : "Remote Administrator 服务器" ,
    4950 : "ICQTrojan" ,
    5000 : "WindowsXP 服务器,Blazer 5,Bubbel,Back Door Setup,Sockets de Troie" ,
    5001 : "Back Door Setup, Sockets de Troie" ,
    5002 : "cd00r,Shaft" ,
    5011 : "One of the Last Trojans(OOTLT)" ,
    5025 : "WM Remote KeyLogger" ,
    5031 : "Firehotcker,Metropolitan,NetMetro" ,
    5032 : "Metropolitan" ,
    5190 : "ICQ Query" ,
    5321 : "Firehotcker" ,
    5333 : "Backage Trojan Box 3" ,
    5343 : "WCrat" ,
    5400 : "Blade Runner,BackConstruction1.2" ,
    5401 : "Blade Runner,BackConstruction" ,
    5402 : "Blade Runner,BackConstruction" ,
    5471 : "WinCrash" ,
    5512 : "Illusion Mailer" ,
    5521 : "Illusion Mailer" ,
    5550 : "Xtcp,INsane Network" ,
    5554 : "Worm.Sasser" ,
    5555 : "ServeMe" ,
    5556 : "BO Facil" ,
    5557 : "BO Facil" ,
    5569 : "Robo-Hack" ,
    5598 : "BackDoor 2.03" ,
    5631 : "PCAnyWhere data" ,
    5632 : "PCAnyWhere" ,
    5637 : "PC Crasher" ,
    5638 : "PC Crasher" ,
    5678 : "Remote Replication Agent Connection" ,
    5679 : "Direct Cable Connect Manager" ,
    5698 : "BackDoor" ,
    5714 : "Wincrash3" ,
    5720 : "Microsoft Licensing" ,
    5741 : "WinCrash3" ,
    5742 : "WinCrash" ,
    5760 : "Portmap Remote Root Linux Exploit" ,
    5880 : "Y3K RAT" ,
    5881 : "Y3K RAT" ,
    5882 : "Y3K RAT" ,
    5888 : "Y3K RAT" ,
    5889 : "Y3K RAT" ,
    5900 : "WinVnc" ,
    6000 : "Backdoor.AB" ,
    6006 : "Noknok8" ,
    6073 : "DirectPlay8" ,
    6129 : "Dameware Nt Utilities 服务器" ,
    6272 : "SecretService" ,
    6267 : "广外女生" ,
    6400 : "Backdoor.AB,The Thing" ,
    6500 : "Devil 1.03" ,
    6661 : "Teman" ,
    6666 : "TCPshell.c" ,
    6667 : "NT Remote Control,Wise 播放器接收端口" ,
    6668 : "Wise Video 广播端口" ,
    6669 : "Vampyre" ,
    6670 : "DeepThroat,iPhone" ,
    6671 : "Deep Throat 3.0" ,
    6711 : "SubSeven" ,
    6712 : "SubSeven1.x" ,
    6713 : "SubSeven" ,
    6723 : "Mstream" ,
    6767 : "NT Remote Control" ,
    6771 : "DeepThroat" ,
    6776 : "BackDoor-G,SubSeven,2000 Cracks" ,
    6777 : "Worm.BBeagle" ,
    6789 : "Doly Trojan" ,
    6838 : "Mstream" ,
    6883 : "DeltaSource" ,
    6912 : "Shit Heep" ,
    6939 : "Indoctrination" ,
    6969 : "GateCrasher, Priority, IRC 3" ,
    6970 : "RealAudio,GateCrasher" ,
    7000 : "Remote Grab,NetMonitor,SubSeven1.x" ,
    7001 : "Freak88, Weblogic 默认端口" ,
    7201 : "NetMonitor" ,
    7215 : "BackDoor-G, SubSeven" ,
    7001 : "Freak88,Freak2k" ,
    7300 : "NetMonitor" ,
    7301 : "NetMonitor" ,
    7306 : "NetMonitor,NetSpy 1.0" ,
    7307 : "NetMonitor, ProcSpy" ,
    7308 : "NetMonitor, X Spy" ,
    7323 : "Sygate 服务器端" ,
    7424 : "Host Control" ,
    7511 : "聪明基因" ,
    7597 : "Qaz" ,
    7609 : "Snid X2" ,
    7626 : "冰河" ,
    7777 : "The Thing" ,
    7789 : "Back Door Setup, ICQKiller" ,
    7983 : "Mstream" ,
    8000 : "腾讯OICQ服务器端,XDMA" ,
    8010 : "Wingate,Logfile" ,
    8011 : "WAY2.4" ,
    8080 : "WWW" ,
    8102 : "网络神偷" ,
    8181 : "W32.Erkez.D@mm" ,
    8520 : "W32.Socay.Worm" ,
    8594 : "I-Worm/Bozori.a" ,
    8787 : "BackOfrice 2000" ,
    8888 : "Winvnc" ,
    8897 : "Hack Office,Armageddon" ,
    8989 : "Recon" ,
    9000 : "Netministrator" ,
    9080 : "WebSphere" ,
    9325 : "Mstream" ,
    9400 : "InCommand 1.0" ,
    9401 : "InCommand 1.0" ,
    9402 : "InCommand 1.0" ,
    9535 : "Remote Man Server" ,
    9872 : "Portal of Doom" ,
    9873 : "Portal of Doom" ,
    9874 : "Portal of Doom" ,
    9875 : "Portal of Doom" ,
    9876 : "Cyber Attacker" ,
    9878 : "TransScout" ,
    9989 : "Ini-Killer" ,
    9898 : "Worm.Win32.Dabber.a" ,
    9999 : "Prayer Trojan" ,
    10067 : "Portal of Doom" ,
    10080 : "Worm.Novarg.B" ,
    10084 : "Syphillis" ,
    10085 : "Syphillis" ,
    10086 : "Syphillis" ,
    10101 : "BrainSpy" ,
    10167 : "Portal Of Doom" ,
    10168 : "Worm.Supnot.78858.c, Worm.LovGate.T" ,
    10520 : "Acid Shivers" ,
    10607 : "Coma trojan" ,
    10666 : "Ambush" ,
    11000 : "Senna Spy" ,
    11050 : "Host Control" ,
    11051 : "Host Control" ,
    11223 : "Progenic,Hack '99KeyLogger" ,
    11320 : "IMIP Channels Port" ,
    11831 : "TROJ_LATINUS.SVR" ,
    12076 : "Gjamer, MSH.104b" ,
    12223 : "Hack'99 KeyLogger" ,
    12345 : "GabanBus, NetBus 1.6/1.7,Pie Bill Gates, X-bill" ,
    12346 : "GabanBus, NetBus 1.6/1.7,X-bill" ,
    12349 : "BioNet" ,
    12361 : "Whack-a-mole" ,
    12362 : "Whack-a-mole" ,
    12363 : "Whack-a-mole" ,
    12378 : "W32/Gibe@MM" ,
    12456 : "NetBus" ,
    12623 : "DUN Control" ,
    12624 : "Buttman" ,
    12631 : "WhackJob, WhackJob.NB1.7" ,
    12701 : "Eclipse2000" ,
    12754 : "Mstream" ,
    13000 : "Senna Spy" ,
    13010 : "Hacker Brazil" ,
    13013 : "Psychward" ,
    13223 : "Tribal Voice 的聊天程序PowWow" ,
    13700 : "Kuang2 The Virus" ,
    14456 : "Solero" ,
    14500 : "PC Invader" ,
    14501 : "PC Invader" ,
    14502 : "PC Invader" ,
    14503 : "PC Invader" ,
    15000 : "NetDaemon 1.0" ,
    15092 : "Host Control" ,
    15104 : "Mstream" ,
    16484 : "Mosucker" ,
    16660 : "Stacheldraht (DDoS)" ,
    16772 : "ICQ Revenge" ,
    16959 : "Priority" ,
    16969 : "Priority" ,
    17027 : "提供广告服务的Conducent 共享软件" ,
    17166 : "Mosaic" ,
    17300 : "Kuang2 The Virus" ,
    17490 : "CrazyNet" ,
    17500 : "CrazyNet" ,
    17569 : "Infector 1.4.x + 1.6.x" ,
    17777 : "Nephron" ,
    18753 : "Shaft (DDoS)" ,
    19191 : "蓝色火焰" ,
    19864 : "ICQ Revenge" ,
    20000 : "Millennium II (GrilFriend)" ,
    20001 : "Millennium II (GrilFriend)" ,
    20002 : "AcidkoR" ,
    20034 : "NetBus 2 Pro" ,
    20168 : "Lovgate" ,
    20203 : "Logged,Chupacabra" ,
    20331 : "Bla" ,
    20432 : "Shaft (DDoS)" ,
    20808 : "Worm.LovGate.v.QQ" ,
    21335 : "Tribal Flood Network,Trinoo" ,
    21544 : "Schwindler 1.82,GirlFriend" ,
    21554 : "Schwindler 1.82,GirlFriend,Exloiter 1.0.1.2" ,
    22222 : "Prosiak,RuX Uploader 2.0" ,
    22784 : "Backdoor.Intruzzo" ,
    23432 : "Asylum 0.1.3" ,
    23444 : "网络公牛" ,
    23456 : "Evil FTP, Ugly FTP, WhackJob" ,
    23476 : "Donald Dick" ,
    23477 : "Donald Dick" ,
    23777 : "INet Spy" ,
    26274 : "Delta" ,
    26681 : "Spy Voice" ,
    27374 : "Sub Seven 2.0+,Backdoor.Baste" ,
    27444 : "Tribal Flood Network,Trinoo" ,
    27665 : "Tribal Flood Network,Trinoo" ,
    29431 : "Hack Attack" ,
    29432 : "Hack Attack" ,
    29104 : "Host Control" ,
    29559 : "TROJ_LATINUS.SVR" ,
    29891 : "The Unexplained" ,
    30001 : "Terr0r32" ,
    30003 : "Death,Lamers Death" ,
    30029 : "AOL trojan" ,
    30100 : "NetSphere 1.27a,NetSphere 1.31" ,
    30101 : "NetSphere 1.31,NetSphere 1.27a" ,
    30102 : "NetSphere 1.27a,NetSphere 1.31" ,
    30103 : "NetSphere 1.31" ,
    30303 : "Sockets de Troie" ,
    30722 : "W32.Esbot.A" ,
    30947 : "Intruse" ,
    30999 : "Kuang2" ,
    31336 : "Bo Whack" ,
    31337 : "Baron Night,BO client,BO2,Bo Facil,BackFire,Back Orifice,DeepBO,Freak2k,NetSpy" ,
    31338 : "NetSpy,Back Orifice,DeepBO" ,
    31339 : "NetSpy DK" ,
    31554 : "Schwindler" ,
    31666 : "BOWhack" ,
    31778 : "Hack Attack" ,
    31785 : "Hack Attack" ,
    31787 : "Hack Attack" ,
    31789 : "Hack Attack" ,
    31791 : "Hack Attack" ,
    31792 : "Hack Attack" ,
    32100 : "PeanutBrittle" ,
    32418 : "Acid Battery" ,
    33333 : "Prosiak,Blakharaz 1.0" ,
    33577 : "Son Of Psychward" ,
    33777 : "Son Of Psychward" ,
    33911 : "Spirit 2001a" ,
    34324 : "BigGluck,TN,Tiny Telnet Server" ,
    34555 : "Trin00 (Windows) (DDoS)" ,
    35555 : "Trin00 (Windows) (DDoS)" ,
    36794 : "Worm.Bugbear-A" ,
    37651 : "YAT" ,
    40412 : "The Spy" ,
    40421 : "Agent 40421,Masters Paradise.96" ,
    40422 : "Masters Paradise" ,
    40423 : "Masters Paradise.97" ,
    40425 : "Masters Paradise" ,
    40426 : "Masters Paradise 3.x" ,
    41666 : "Remote Boot" ,
    43210 : "Schoolbus 1.6/2.0" ,
    44444 : "Delta Source" ,
    44445 : "Happypig" ,
    45576 : "未知代理" ,
    47252 : "Prosiak" ,
    47262 : "Delta" ,
    47624 : "Direct Play Server" ,
    47878 : "BirdSpy2" ,
    49301 : "Online Keylogger" ,
    50505 : "Sockets de Troie" ,
    50766 : "Fore, Schwindler" ,
    51966 : "CafeIni" ,
    53001 : "Remote Windows Shutdown" ,
    53217 : "Acid Battery 2000" ,
    54283 : "Back Door-G, Sub7" ,
    54320 : "Back Orifice 2000,Sheep" ,
    54321 : "School Bus .69-1.11,Sheep,BO2K" ,
    57341 : "NetRaider" ,
    58008 : "BackDoor.Tron" ,
    58009 : "BackDoor.Tron" ,
    58339 : "ButtFunnel" ,
    59211 : "BackDoor.DuckToy" ,
    60000 : "Deep Throat" ,
    60068 : "Xzip 6000068" ,
    60411 : "Connection" ,
    60606 : "TROJ_BCKDOR.G2.A" ,
    61466 : "Telecommando" ,
    61603 : "Bunker-kill" ,
    63485 : "Bunker-kill" ,
    65000 : "Devil, DDoS" ,
    65432 : "Th3tr41t0r, The Traitor" ,
    65530 : "TROJ_WINMITE.10" ,
    65535 : "RC,Adore Worm/Linux" ,
    69123 : "ShitHeep" ,
    88798 : "Armageddon,Hack Office"    
}

udp_wellknown_port = {
    1 : "Sockets des Troie" ,
    9 : "Chargen" ,
    19 : "Chargen" ,
    69 : "Pasana" ,
    80 : "Penrox" ,
    371 : "ClearCase 版本管理软件" ,
    445 : "公共Internet 文件系统(CIFS)" ,
    500 : "Internet 密钥交换" ,
    1025 : "Maverick's Matrix 1.2 - 2.0" ,
    1026 : "Remote Explorer 2000" ,
    1027 : "HP 服务,UC 聊天软件, Trojan.Huigezi.e" ,
    1028 : "应用层网关服务,KiLo,SubSARI" ,
    1029 : "SubSARI" ,
    1031 : "Xot" ,
    1032 : "Akosch4" ,
    1104 : "RexxRave" ,
    1111 : "Daodan" ,
    1116 : "Lurker" ,
    1122 : "Last 2000,Singularity" ,
    1183 : "Cyn,SweetHeart" ,
    1200 : "NoBackO" ,
    1201 : "NoBackO" ,
    1342 : "BLA trojan" ,
    1344 : "Ptakks" ,
    1349 : "BO dll" ,
    1512 : "Microsoft Windows Internet Name Service" ,
    1561 : "MuSka52" ,
    1772 : "NetControle" ,
    1801 : "Microsoft Message Queue" ,
    1978 : "Slapper" ,
    1985 : "Black Diver" ,
    2000 : "A-trojan,Fear,Force,GOTHIC Intruder,Last 2000,Real 2000" ,
    2001 : "Scalper" ,
    2002 : "Slapper" ,
    2015 : "raid-cs" ,
    2018 : "rellpack" ,
    2130 : "Mini BackLash" ,
    2140 : "Deep Throat,Foreplay,The Invasor" ,
    2222 : "SweetHeart,Way, Backdoor/Mifeng.t" ,
    2234 : "DirectPlay" ,
    2339 : "Voice Spy" ,
    2702 : "Black Diver" ,
    2989 : "RAT" ,
    3074 : "Microsoft Xbox game port" ,
    3132 : "Microsoft Business Rule Engine Update Service" ,
    3150 : "Deep Throat" ,
    3215 : "XHX" ,
    3268 : "Microsoft Global Catalog" ,
    3269 : "Microsoft Global Catalog with LDAP/SSL" ,
    3333 : "Daodan" ,
    3535 : "Microsoft Class Server" ,
    3801 : "Eclypse" ,
    3996 : "Remote Anything" ,
    4128 : "RedShad" ,
    4156 : "Slapper" ,
    4350 : "Net Device" ,
    4500 : "Microsoft IPsec NAT-T, sae-urn" ,
    5419 : "DarkSky" ,
    5503 : "Remote Shell Trojan" ,
    5555 : "Daodan" ,
    5678 : "Remote Replication Agent Connection" ,
    5679 : "Direct Cable Connect Manager" ,
    5720 : "Microsoft Licensing" ,
    5882 : "Y3K RAT" ,
    5888 : "Y3K RAT" ,
    6073 : "DirectPlay8" ,
    6112 : "Battle. net Game" ,
    6666 : "KiLo" ,
    6667 : "KiLo" ,
    6766 : "KiLo" ,
    6767 : "KiLo,UandMe" ,
    6838 : "Mstream Agent-handler" ,
    7028 : "未知木马" ,
    7424 : "Host Control" ,
    7788 : "Singularity" ,
    7983 : "MStream handler-agent" ,
    8012 : "Ptakks" ,
    8090 : "Aphex's Remote Packet Sniffer" ,
    8127 : "9_119,Chonker" ,
    8488 : "KiLo" ,
    8489 : "KiLo" ,
    8787 : "BackOrifice 2000" ,
    8879 : "BackOrifice 2000" ,
    9325 : "MStream Agent-handler" ,
    10000 : "XHX" ,
    10067 : "Portal of Doom" ,
    10084 : "Syphillis" ,
    10100 : "Slapper" ,
    10167 : "Portal of Doom" ,
    10498 : "Mstream" ,
    10666 : "Ambush" ,
    11225 : "Cyn" ,
    12321 : "Protoss" ,
    12345 : "BlueIce 2000" ,
    12378 : "W32/Gibe@MM" ,
    12623 : "ButtMan,DUN Control" ,
    11320 : "IMIP Channels Port" ,
    15210 : "UDP remote shell backdoor server" ,
    15486 : "KiLo" ,
    16514 : "KiLo" ,
    16515 : "KiLo" ,
    18753 : "Shaft handler to Agent" ,
    20433 : "Shaft" ,
    21554 : "GirlFriend" ,
    22784 : "Backdoor.Intruzzo" ,
    23476 : "Donald Dick" ,
    25123 : "MOTD" ,
    26274 : "Delta Source" ,
    26374 : "Sub-7 2.1" ,
    26444 : "Trin00/TFN2K" ,
    26573 : "Sub-7 2.1" ,
    27184 : "Alvgus trojan 2000" ,
    27444 : "Trinoo" ,
    29589 : "KiLo" ,
    29891 : "The Unexplained" ,
    30103 : "NetSphere" ,
    31320 : "Little Witch" ,
    31335 : "Trin00 DoS Attack" ,
    31337 : "Baron Night, BO client, BO2, Bo Facil, BackFire, Back Orifice, DeepBO" ,
    31338 : "Back Orifice, NetSpy DK,DeepBO" ,
    31339 : "Little Witch" ,
    31340 : "Little Witch" ,
    31416 : "Lithium" ,
    31787 : "Hack aTack" ,
    31789 : "Hack aTack" ,
    31790 : "Hack aTack" ,
    31791 : "Hack aTack" ,
    33390 : "未知木马" ,
    34555 : "Trinoo" ,
    35555 : "Trinoo" ,
    43720 : "KiLo" ,
    44014 : "Iani" ,
    44767 : "School Bus" ,
    46666 : "Taskman" ,
    47262 : "Delta Source" ,
    47624 : "Direct Play Server" ,
    47785 : "KiLo" ,
    49301 : "OnLine keyLogger" ,
    49683 : "Fenster" ,
    49698 : "KiLo" ,
    52901 : "Omega" ,
    54320 : "Back Orifice" ,
    54321 : "Back Orifice 2000" ,
    54341 : "NetRaider Trojan" ,
    61746 : "KiLO" ,
    61747 : "KiLO" ,
    61748 : "KiLO" ,
    65432 : "The Traitor"
}

Pair = namedtuple('Pair', 'src dest')

def getIPs(flow):
    use_ipv4 = False  # optimistic default case of IPv6

    if 'IP_PROTOCOL_VERSION' in flow and flow['IP_PROTOCOL_VERSION'] == 4:
        use_ipv4 = True
    elif 'IPV4_SRC_ADDR' in flow or 'IPV4_DST_ADDR' in flow:
        use_ipv4 = True

    if use_ipv4:
        return Pair(
            ipaddress.ip_address(flow['IPV4_SRC_ADDR']),
            ipaddress.ip_address(flow['IPV4_DST_ADDR']))

    # else: return IPv6 pair
    return Pair(
        ipaddress.ip_address(flow['IPV6_SRC_ADDR']),
        ipaddress.ip_address(flow['IPV6_DST_ADDR']))


class Connection:
    """Connection model for two flows.
    The direction of the data flow can be seen by looking at the size.

    'src' describes the peer which sends more data towards the other. This
    does NOT have to mean, that 'src' was the initiator of the connection.
    """
    def __init__(self, flow1, flow2):
        if flow1['IN_BYTES'] >= flow2['IN_BYTES']:
            src = flow1
            dest = flow2
        else:
            src = flow2
            dest = flow1

        ips = getIPs(src)
        self.src = ips.src
        self.dest = ips.dest
        self.src_port = src['L4_SRC_PORT']
        self.dest_port = src['L4_DST_PORT']
        self.size = src['IN_BYTES']
        self.protocol = src['PROTOCOL']  # 增加协议解析

        # Duration is given in milliseconds
        self.duration = src['LAST_SWITCHED'] - src['FIRST_SWITCHED']
        if self.duration < 0:
            # 32 bit int has its limits. Handling overflow here
            self.duration = (2**32 - src['FIRST_SWITCHED']) + src['LAST_SWITCHED']

    def __repr__(self):
        return "<Connection from {} to {}, size {}>".format(
            self.src, self.dest, self.human_size)

    @property
    def human_size(self):
        # Calculate a human readable size of the traffic
        if self.size < 1024:
            return "%dB" % self.size
        elif self.size / 1024. < 1024:
            return "%.2fK" % (self.size / 1024.)
        elif self.size / 1024.**2 < 1024:
            return "%.2fM" % (self.size / 1024.**2)
        else:
            return "%.2fG" % (self.size / 1024.**3)

    @property
    def human_duration(self):
        duration = self.duration // 1000  # uptime in milliseconds, floor it
        if duration < 60:
            # seconds
            return "%d sec" % duration
        if duration / 60 > 60:
            # hours
            return "%d:%02d.%02d hours" % (duration / 60**2, duration % 60**2 / 60, duration % 60)
        # minutes
        return "%02d:%02d min" % (duration / 60, duration % 60)

    @property
    def hostnames(self):
        # Resolve the IPs of this flows to their hostname
        src_hostname = self.src # socket.getfqdn(self.src.compressed)
        dest_hostname = self.dest #socket.getfqdn(self.dest.compressed)

        return Pair(src_hostname, dest_hostname)

    @property
    def flowprotocol(self):
        #从protocol字典钟获取对应的协议
        protocol = protocal_dict.get(self.protocol)

        return protocol

    @property
    def service(self):
        # Resolve ports to their services, if known
        service = "unknown"

        if self.protocol == 6: #TCP
            service = tcp_wellknown_port.get(self.src_port)
            if service == None:
                service = tcp_wellknown_port.get(self.dest_port)
                if service == None:
                    service = "unknown"
                    # 记录日志
        elif self.protocol ==17: #UDP
            service = udp_wellknown_port.get(self.src_port)
            if service == None:
                service = udp_wellknown_port.get(self.dest_port)
                if service == None:
                    service = "unknown"
                    # 记录日志
        return service


# Handle CLI args and load the data dump
if len(sys.argv) < 2:
    exit("Use {} <filename>.json".format(sys.argv[0]))
filename = sys.argv[1]
if not os.path.exists(filename):
    exit("File {} does not exist!".format(filename))
with open(filename, 'r') as fh:
    data = json.loads(fh.read())


# Go through data and disect every flow saved inside the dump
for export in sorted(data):
    timestamp = datetime.fromtimestamp(float(export)).strftime("%Y-%m-%d %H:%M.%S")

    flows = data[export]

    if len(flows) == 1:
        flow = flows[0]
        con = Connection(flow, flow)
        print("{timestamp}: {protocol:8} {service:7} | {size:8} | {duration:9} | {src_host} ({src}) to"\
            " {dest_host} ({dest})".format(
            timestamp=timestamp, protocol = con.flowprotocol, service=con.service.upper(),
            src_host=con.hostnames.src, src=con.src,
            dest_host=con.hostnames.dest, dest=con.dest,
            size=con.human_size, duration=con.human_duration))
    else:
        pending = None  # Two flows normally appear together for duplex connection
        for flow in flows:
            if not pending:
                pending = flow
            else:
                con = Connection(pending, flow)
                print("{timestamp}: {protocol:8} {service:7} | {size:8} | {duration:9} | {src_host} ({src}) to"\
                    " {dest_host} ({dest})".format(
                    timestamp=timestamp, protocol = con.flowprotocol, service=con.service.upper(),
                    src_host=con.hostnames.src, src=con.src,
                    dest_host=con.hostnames.dest, dest=con.dest,
                    size=con.human_size, duration=con.human_duration))
                pending = None
